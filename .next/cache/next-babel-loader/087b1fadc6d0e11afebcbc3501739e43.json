{"ast":null,"code":"\"use strict\";var _interopRequireDefault2=require(\"@babel/runtime/helpers/interopRequireDefault\");var _classCallCheck2=_interopRequireDefault2(require(\"@babel/runtime/helpers/classCallCheck\"));var _createClass2=_interopRequireDefault2(require(\"@babel/runtime/helpers/createClass\"));var _interopRequireDefault=require(\"@babel/runtime/helpers/interopRequireDefault\");exports.__esModule=true;exports.default=void 0;var _url=require(\"url\");var _mitt=_interopRequireDefault(require(\"../next-server/lib/mitt\"));var _isDynamic=require(\"./../next-server/lib/router/utils/is-dynamic\");var _routeMatcher=require(\"./../next-server/lib/router/utils/route-matcher\");var _routeRegex=require(\"./../next-server/lib/router/utils/route-regex\");var _router=require(\"./../next-server/lib/router/router\");function hasRel(rel,link){try{link=document.createElement('link');return link.relList.supports(rel);}catch(_unused){}}var relPrefetch=hasRel('preload')&&!hasRel('prefetch')?'preload':'prefetch';var hasNoModule=('noModule'in document.createElement('script'));function normalizeRoute(route){if(route[0]!=='/'){throw new Error(\"Route name should start with a \\\"/\\\", got \\\"\"+route+\"\\\"\");}route=route.replace(/\\/index$/,'/');if(route==='/')return route;return route.replace(/\\/$/,'');}function appendLink(href,rel,as){return new Promise(function(res,rej,link){link=document.createElement('link');link.crossOrigin=process.crossOrigin;link.href=href;link.rel=rel;if(as)link.as=as;link.onload=res;link.onerror=rej;document.head.appendChild(link);});}var PageLoader=function(){function PageLoader(buildId,assetPrefix){(0,_classCallCheck2.default)(this,PageLoader);this.buildId=buildId;this.assetPrefix=assetPrefix;this.pageCache={};this.pageRegisterEvents=(0,_mitt.default)();this.loadingRoutes={};if(process.env.__NEXT_GRANULAR_CHUNKS){this.promisedBuildManifest=new Promise(function(resolve){if(window.__BUILD_MANIFEST){resolve(window.__BUILD_MANIFEST);}else{window.__BUILD_MANIFEST_CB=function(){resolve(window.__BUILD_MANIFEST);};}});}this.promisedSsgManifest=new Promise(function(resolve){if(window.__SSG_MANIFEST){resolve(window.__SSG_MANIFEST);}else{window.__SSG_MANIFEST_CB=function(){resolve(window.__SSG_MANIFEST);};}});}(0,_createClass2.default)(PageLoader,[{key:\"getDependencies\",value:function getDependencies(route){var _this=this;return this.promisedBuildManifest.then(function(man){return man[route]&&man[route].map(function(url){return _this.assetPrefix+\"/_next/\"+encodeURI(url);})||[];});}},{key:\"getDataHref\",value:function getDataHref(href,asPath){var _this2=this;var getHrefForSlug=function getHrefForSlug(path){path=(0,_router.delBasePath)(path);return _this2.assetPrefix+\"/_next/data/\"+_this2.buildId+(path==='/'?'/index':path)+\".json\";};var _ref2=(0,_url.parse)(href,true),hrefPathname=_ref2.pathname,query=_ref2.query;var _ref3=(0,_url.parse)(asPath),asPathname=_ref3.pathname;var route=normalizeRoute(hrefPathname);var isDynamic=(0,_isDynamic.isDynamicRoute)(route),interpolatedRoute;if(isDynamic){var dynamicRegex=(0,_routeRegex.getRouteRegex)(route);var dynamicGroups=dynamicRegex.groups;var dynamicMatches=(0,_routeMatcher.getRouteMatcher)(dynamicRegex)(asPathname)||query;interpolatedRoute=route;if(!Object.keys(dynamicGroups).every(function(param){var value=dynamicMatches[param];var repeat=dynamicGroups[param].repeat;if(repeat&&!Array.isArray(value))value=[value];return param in dynamicMatches&&(interpolatedRoute=interpolatedRoute.replace(\"[\"+(repeat?'...':'')+param+\"]\",repeat?value.map(encodeURIComponent).join('/'):encodeURIComponent(value)));})){interpolatedRoute='';}}return isDynamic?interpolatedRoute&&getHrefForSlug(interpolatedRoute):getHrefForSlug(route);}},{key:\"prefetchData\",value:function prefetchData(href,asPath){var _this3=this;var _ref4=(0,_url.parse)(href,true),hrefPathname=_ref4.pathname;var route=normalizeRoute(hrefPathname);return this.promisedSsgManifest.then(function(s,_dataHref){return s.has(route)&&(_dataHref=_this3.getDataHref(href,asPath))&&!document.querySelector(\"link[rel=\\\"\"+relPrefetch+\"\\\"][href^=\\\"\"+_dataHref+\"\\\"]\")&&appendLink(_dataHref,relPrefetch,'fetch');});}},{key:\"loadPage\",value:function loadPage(route){return this.loadPageScript(route);}},{key:\"loadPageScript\",value:function loadPageScript(route){var _this4=this;route=normalizeRoute(route);return new Promise(function(resolve,reject){var fire=function fire(_ref){var error=_ref.error,page=_ref.page,mod=_ref.mod;_this4.pageRegisterEvents.off(route,fire);delete _this4.loadingRoutes[route];if(error){reject(error);}else{resolve({page:page,mod:mod});}};var cachedPage=_this4.pageCache[route];if(cachedPage){var error=cachedPage.error,page=cachedPage.page,mod=cachedPage.mod;error?reject(error):resolve({page:page,mod:mod});return;}_this4.pageRegisterEvents.on(route,fire);if(document.querySelector(\"script[data-next-page=\\\"\"+route+\"\\\"]\")){return;}if(!_this4.loadingRoutes[route]){_this4.loadingRoutes[route]=true;if(process.env.__NEXT_GRANULAR_CHUNKS){_this4.getDependencies(route).then(function(deps){deps.forEach(function(d){if(/\\.js$/.test(d)&&!document.querySelector(\"script[src^=\\\"\"+d+\"\\\"]\")){_this4.loadScript(d,route,false);}if(/\\.css$/.test(d)&&!document.querySelector(\"link[rel=stylesheet][href^=\\\"\"+d+\"\\\"]\")){appendLink(d,'stylesheet').catch(function(){});}});_this4.loadRoute(route);});}else{_this4.loadRoute(route);}}});}},{key:\"loadRoute\",value:function loadRoute(route){route=normalizeRoute(route);var scriptRoute=route==='/'?'/index.js':route+\".js\";var url=this.assetPrefix+\"/_next/static/\"+encodeURIComponent(this.buildId)+\"/pages\"+encodeURI(scriptRoute);this.loadScript(url,route,true);}},{key:\"loadScript\",value:function loadScript(url,route,isPage){var _this5=this;var script=document.createElement('script');if(process.env.__NEXT_MODERN_BUILD&&hasNoModule){script.type='module';if(isPage)url=url.replace(/\\.js$/,'.module.js');}script.crossOrigin=process.crossOrigin;script.src=url;script.onerror=function(){var error=new Error(\"Error loading script \"+url);error.code='PAGE_LOAD_ERROR';_this5.pageRegisterEvents.emit(route,{error:error});};document.body.appendChild(script);}},{key:\"registerPage\",value:function registerPage(route,regFn){var _this6=this;var register=function register(){try{var mod=regFn();var pageData={page:mod.default||mod,mod:mod};_this6.pageCache[route]=pageData;_this6.pageRegisterEvents.emit(route,pageData);}catch(error){_this6.pageCache[route]={error:error};_this6.pageRegisterEvents.emit(route,{error:error});}};if(false){if(module.hot&&module.hot.status()!=='idle'){console.log(\"Waiting for webpack to become \\\"idle\\\" to initialize the page: \\\"\"+route+\"\\\"\");var check=function check(status){if(status==='idle'){module.hot.removeStatusHandler(check);register();}};module.hot.status(check);return;}}register();}},{key:\"prefetch\",value:function prefetch(route,isDependency){var _this7=this;var cn;if(cn=navigator.connection){if(cn.saveData||/2g/.test(cn.effectiveType))return Promise.resolve();}var url;if(isDependency){url=route;}else{route=normalizeRoute(route);var scriptRoute=(route==='/'?'/index':route)+\".js\";if(process.env.__NEXT_MODERN_BUILD&&hasNoModule){scriptRoute=scriptRoute.replace(/\\.js$/,'.module.js');}url=this.assetPrefix+\"/_next/static/\"+encodeURIComponent(this.buildId)+\"/pages\"+encodeURI(scriptRoute);}return Promise.all(document.querySelector(\"link[rel=\\\"\"+relPrefetch+\"\\\"][href^=\\\"\"+url+\"\\\"], script[data-next-page=\\\"\"+route+\"\\\"]\")?[]:[appendLink(url,relPrefetch,url.match(/\\.css$/)?'style':'script'),process.env.__NEXT_GRANULAR_CHUNKS&&!isDependency&&this.getDependencies(route).then(function(urls){return Promise.all(urls.map(function(url){return _this7.prefetch(url,true);}));})]).then(function(){},function(){});}}]);return PageLoader;}();exports.default=PageLoader;","map":null,"metadata":{},"sourceType":"script"}