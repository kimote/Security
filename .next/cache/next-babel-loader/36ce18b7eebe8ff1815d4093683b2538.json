{"ast":null,"code":"\"use strict\";var _interopRequireDefault=require(\"@babel/runtime/helpers/interopRequireDefault\");var _regenerator=_interopRequireDefault(require(\"@babel/runtime/regenerator\"));var _slicedToArray2=_interopRequireDefault(require(\"@babel/runtime/helpers/slicedToArray\"));var _extends2=_interopRequireDefault(require(\"@babel/runtime/helpers/extends\"));var _classCallCheck2=_interopRequireDefault(require(\"@babel/runtime/helpers/classCallCheck\"));var _createClass2=_interopRequireDefault(require(\"@babel/runtime/helpers/createClass\"));var __importDefault=void 0&&(void 0).__importDefault||function(mod){return mod&&mod.__esModule?mod:{\"default\":mod};};Object.defineProperty(exports,\"__esModule\",{value:true});var url_1=require(\"url\");var mitt_1=__importDefault(require(\"../mitt\"));var utils_1=require(\"../utils\");var is_dynamic_1=require(\"./utils/is-dynamic\");var route_matcher_1=require(\"./utils/route-matcher\");var route_regex_1=require(\"./utils/route-regex\");var basePath=process.env.__NEXT_ROUTER_BASEPATH||'';function addBasePath(path){return path.indexOf(basePath)!==0?basePath+path:path;}exports.addBasePath=addBasePath;function delBasePath(path){return path.indexOf(basePath)===0?path.substr(basePath.length)||'/':path;}exports.delBasePath=delBasePath;function toRoute(path){return path.replace(/\\/$/,'')||'/';}var prepareRoute=function prepareRoute(path){return toRoute(!path||path==='/'?'/index':path);};function fetchNextData(pathname,query,isServerRender,cb){var attempts=isServerRender?3:1;function getResponse(){return fetch(utils_1.formatWithValidation({pathname:addBasePath(\"/_next/data/\"+__NEXT_DATA__.buildId+delBasePath(pathname)+\".json\"),query:query}),{credentials:'same-origin'}).then(function(res){if(!res.ok){if(--attempts>0&&res.status>=500){return getResponse();}throw new Error(\"Failed to load static props\");}return res.json();});}return getResponse().then(function(data){return cb?cb(data):data;}).catch(function(err){if(!isServerRender){;err.code='PAGE_LOAD_ERROR';}throw err;});}var Router=function(){function Router(pathname,query,as,_ref){var _this=this;var initialProps=_ref.initialProps,pageLoader=_ref.pageLoader,App=_ref.App,wrapApp=_ref.wrapApp,Component=_ref.Component,err=_ref.err,subscription=_ref.subscription,isFallback=_ref.isFallback;(0,_classCallCheck2.default)(this,Router);this.sdc={};this.onPopState=function(e){if(!e.state){var _pathname=_this.pathname,_query=_this.query;_this.changeState('replaceState',utils_1.formatWithValidation({pathname:_pathname,query:_query}),utils_1.getURL());return;}if(e.state&&_this.isSsr&&e.state.as===_this.asPath&&url_1.parse(e.state.url).pathname===_this.pathname){return;}if(_this._bps&&!_this._bps(e.state)){return;}var _e$state=e.state,url=_e$state.url,as=_e$state.as,options=_e$state.options;if(false){if(typeof url==='undefined'||typeof as==='undefined'){console.warn('`popstate` event triggered but `event.state` did not have `url` or `as` https://err.sh/zeit/next.js/popstate-state-empty');}}_this.replace(url,as,options);};this._getStaticData=function(asPath){var pathname=prepareRoute(url_1.parse(asPath).pathname);return true&&_this.sdc[pathname]?Promise.resolve(_this.sdc[pathname]):fetchNextData(pathname,null,_this.isSsr,function(data){return _this.sdc[pathname]=data;});};this._getServerData=function(asPath){var _url_1$parse=url_1.parse(asPath,true),pathname=_url_1$parse.pathname,query=_url_1$parse.query;pathname=prepareRoute(pathname);return fetchNextData(pathname,query,_this.isSsr);};this.route=toRoute(pathname);this.components={};if(pathname!=='/_error'){this.components[this.route]={Component:Component,props:initialProps,err:err,__N_SSG:initialProps&&initialProps.__N_SSG,__N_SSP:initialProps&&initialProps.__N_SSP};}this.components['/_app']={Component:App};this.events=Router.events;this.pageLoader=pageLoader;this.pathname=pathname;this.query=query;this.asPath=is_dynamic_1.isDynamicRoute(pathname)&&__NEXT_DATA__.autoExport?pathname:as;this.basePath=basePath;this.sub=subscription;this.clc=null;this._wrapApp=wrapApp;this.isSsr=true;this.isFallback=isFallback;if(true){if(as.substr(0,2)!=='//'){this.changeState('replaceState',utils_1.formatWithValidation({pathname:pathname,query:query}),as);}window.addEventListener('popstate',this.onPopState);}}(0,_createClass2.default)(Router,[{key:\"update\",value:function update(route,mod){var Component=mod.default||mod;var data=this.components[route];if(!data){throw new Error(\"Cannot update unavailable route: \"+route);}var newData=(0,_extends2.default)((0,_extends2.default)({},data),{Component:Component,__N_SSG:mod.__N_SSG,__N_SSP:mod.__N_SSP});this.components[route]=newData;if(route==='/_app'){this.notify(this.components[this.route]);return;}if(route===this.route){this.notify(newData);}}},{key:\"reload\",value:function reload(){window.location.reload();}},{key:\"back\",value:function back(){window.history.back();}},{key:\"push\",value:function push(url){var as=arguments.length>1&&arguments[1]!==undefined?arguments[1]:url;var options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return this.change('pushState',url,as,options);}},{key:\"replace\",value:function replace(url){var as=arguments.length>1&&arguments[1]!==undefined?arguments[1]:url;var options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return this.change('replaceState',url,as,options);}},{key:\"change\",value:function change(method,_url,_as,options){var _this2=this;return new Promise(function(resolve,reject){if(!options._h){_this2.isSsr=false;}if(utils_1.ST){performance.mark('routeChange');}var url=typeof _url==='object'?utils_1.formatWithValidation(_url):_url;var as=typeof _as==='object'?utils_1.formatWithValidation(_as):_as;url=addBasePath(url);as=addBasePath(as);if(process.env.__NEXT_EXPORT_TRAILING_SLASH){var rewriteUrlForNextExport=require(\"./rewrite-url-for-export\").rewriteUrlForNextExport;if(__NEXT_DATA__.nextExport){as=rewriteUrlForNextExport(as);}}_this2.abortComponentLoad(as);if(!options._h&&_this2.onlyAHashChange(as)){_this2.asPath=as;Router.events.emit('hashChangeStart',as);_this2.changeState(method,url,as,options);_this2.scrollToHash(as);Router.events.emit('hashChangeComplete',as);return resolve(true);}var _url_1$parse2=url_1.parse(url,true),pathname=_url_1$parse2.pathname,query=_url_1$parse2.query,protocol=_url_1$parse2.protocol;if(!pathname||protocol){if(false){throw new Error(\"Invalid href passed to router: \"+url+\" https://err.sh/zeit/next.js/invalid-href-passed\");}return resolve(false);}if(!_this2.urlIsNew(as)){method='replaceState';}var route=toRoute(pathname);var _options$shallow=options.shallow,shallow=_options$shallow===void 0?false:_options$shallow;if(is_dynamic_1.isDynamicRoute(route)){var _url_1$parse3=url_1.parse(as),asPathname=_url_1$parse3.pathname;var routeRegex=route_regex_1.getRouteRegex(route);var routeMatch=route_matcher_1.getRouteMatcher(routeRegex)(asPathname);if(!routeMatch){var missingParams=Object.keys(routeRegex.groups).filter(function(param){return!query[param];});if(missingParams.length>0){if(false){console.warn(\"Mismatching `as` and `href` failed to manually provide \"+(\"the params: \"+missingParams.join(', ')+\" in the `href`'s `query`\"));}return reject(new Error(\"The provided `as` value (\"+asPathname+\") is incompatible with the `href` value (\"+route+\"). \"+\"Read more: https://err.sh/zeit/next.js/incompatible-href-as\"));}}else{(0,_extends2.default)(query,routeMatch);}}Router.events.emit('routeChangeStart',as);_this2.getRouteInfo(route,pathname,query,as,shallow).then(function(routeInfo){var error=routeInfo.error;if(error&&error.cancelled){return resolve(false);}Router.events.emit('beforeHistoryChange',as);_this2.changeState(method,url,as,options);if(false){var appComp=_this2.components['/_app'].Component;window.next.isPrerendered=appComp.getInitialProps===appComp.origGetInitialProps&&!routeInfo.Component.getInitialProps;}_this2.set(route,pathname,query,as,routeInfo);if(error){Router.events.emit('routeChangeError',error,as);throw error;}Router.events.emit('routeChangeComplete',as);return resolve(true);},reject);});}},{key:\"changeState\",value:function changeState(method,url,as){var options=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};if(false){if(typeof window.history==='undefined'){console.error(\"Warning: window.history is not available.\");return;}if(typeof window.history[method]==='undefined'){console.error(\"Warning: window.history.\"+method+\" is not available\");return;}}if(method!=='pushState'||utils_1.getURL()!==as){window.history[method]({url:url,as:as,options:options},'',as);}}},{key:\"getRouteInfo\",value:function getRouteInfo(route,pathname,query,as){var _this3=this;var shallow=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;var cachedRouteInfo=this.components[route];if(shallow&&cachedRouteInfo&&this.route===route){return Promise.resolve(cachedRouteInfo);}var handleError=function handleError(err,loadErrorFail){return new Promise(function(resolve){if(err.code==='PAGE_LOAD_ERROR'||loadErrorFail){window.location.href=as;err.cancelled=true;return resolve({error:err});}if(err.cancelled){return resolve({error:err});}resolve(_this3.fetchComponent('/_error').then(function(res){var Component=res.page;var routeInfo={Component:Component,err:err};return new Promise(function(resolve){_this3.getInitialProps(Component,{err:err,pathname:pathname,query:query}).then(function(props){routeInfo.props=props;routeInfo.error=err;resolve(routeInfo);},function(gipErr){console.error('Error in error page `getInitialProps`: ',gipErr);routeInfo.error=err;routeInfo.props={};resolve(routeInfo);});});}).catch(function(err){return handleError(err,true);}));});};return new Promise(function(resolve,reject){if(cachedRouteInfo){return resolve(cachedRouteInfo);}_this3.fetchComponent(route).then(function(res){return resolve({Component:res.page,__N_SSG:res.mod.__N_SSG,__N_SSP:res.mod.__N_SSP});},reject);}).then(function(routeInfo){var Component=routeInfo.Component,__N_SSG=routeInfo.__N_SSG,__N_SSP=routeInfo.__N_SSP;if(false){var _require=require('react-is'),isValidElementType=_require.isValidElementType;if(!isValidElementType(Component)){throw new Error(\"The default export is not a React Component in page: \\\"\"+pathname+\"\\\"\");}}return _this3._getData(function(){return __N_SSG?_this3._getStaticData(as):__N_SSP?_this3._getServerData(as):_this3.getInitialProps(Component,{pathname:pathname,query:query,asPath:as});}).then(function(props){routeInfo.props=props;_this3.components[route]=routeInfo;return routeInfo;});}).catch(handleError);}},{key:\"set\",value:function set(route,pathname,query,as,data){this.isFallback=false;this.route=route;this.pathname=pathname;this.query=query;this.asPath=as;this.notify(data);}},{key:\"beforePopState\",value:function beforePopState(cb){this._bps=cb;}},{key:\"onlyAHashChange\",value:function onlyAHashChange(as){if(!this.asPath)return false;var _this$asPath$split=this.asPath.split('#'),_this$asPath$split2=(0,_slicedToArray2.default)(_this$asPath$split,2),oldUrlNoHash=_this$asPath$split2[0],oldHash=_this$asPath$split2[1];var _as$split=as.split('#'),_as$split2=(0,_slicedToArray2.default)(_as$split,2),newUrlNoHash=_as$split2[0],newHash=_as$split2[1];if(newHash&&oldUrlNoHash===newUrlNoHash&&oldHash===newHash){return true;}if(oldUrlNoHash!==newUrlNoHash){return false;}return oldHash!==newHash;}},{key:\"scrollToHash\",value:function scrollToHash(as){var _as$split3=as.split('#'),_as$split4=(0,_slicedToArray2.default)(_as$split3,2),hash=_as$split4[1];if(hash===''){window.scrollTo(0,0);return;}var idEl=document.getElementById(hash);if(idEl){idEl.scrollIntoView();return;}var nameEl=document.getElementsByName(hash)[0];if(nameEl){nameEl.scrollIntoView();}}},{key:\"urlIsNew\",value:function urlIsNew(asPath){return this.asPath!==asPath;}},{key:\"prefetch\",value:function prefetch(url){var _this4=this;var asPath=arguments.length>1&&arguments[1]!==undefined?arguments[1]:url;var options=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};return new Promise(function(resolve,reject){var _url_1$parse4=url_1.parse(url),pathname=_url_1$parse4.pathname,protocol=_url_1$parse4.protocol;if(!pathname||protocol){if(false){throw new Error(\"Invalid href passed to router: \"+url+\" https://err.sh/zeit/next.js/invalid-href-passed\");}return;}if(false){return;}var route=delBasePath(toRoute(pathname));Promise.all([_this4.pageLoader.prefetchData(url,delBasePath(asPath)),_this4.pageLoader[options.priority?'loadPage':'prefetch'](route)]).then(function(){return resolve();},reject);});}},{key:\"fetchComponent\",value:function fetchComponent(route){var cancelled,cancel,componentResult,error;return _regenerator.default.async(function fetchComponent$(_context){while(1){switch(_context.prev=_context.next){case 0:cancelled=false;cancel=this.clc=function(){cancelled=true;};route=delBasePath(route);_context.next=5;return _regenerator.default.awrap(this.pageLoader.loadPage(route));case 5:componentResult=_context.sent;if(!cancelled){_context.next=10;break;}error=new Error(\"Abort fetching component for route: \\\"\"+route+\"\\\"\");error.cancelled=true;throw error;case 10:if(cancel===this.clc){this.clc=null;}return _context.abrupt(\"return\",componentResult);case 12:case\"end\":return _context.stop();}}},null,this,null,Promise);}},{key:\"_getData\",value:function _getData(fn){var _this5=this;var cancelled=false;var cancel=function cancel(){cancelled=true;};this.clc=cancel;return fn().then(function(data){if(cancel===_this5.clc){_this5.clc=null;}if(cancelled){var err=new Error('Loading initial props cancelled');err.cancelled=true;throw err;}return data;});}},{key:\"getInitialProps\",value:function getInitialProps(Component,ctx){var App=this.components['/_app'].Component;var AppTree=this._wrapApp(App);ctx.AppTree=AppTree;return utils_1.loadGetInitialProps(App,{AppTree:AppTree,Component:Component,router:this,ctx:ctx});}},{key:\"abortComponentLoad\",value:function abortComponentLoad(as){if(this.clc){var e=new Error('Route Cancelled');e.cancelled=true;Router.events.emit('routeChangeError',e,as);this.clc();this.clc=null;}}},{key:\"notify\",value:function notify(data){this.sub(data,this.components['/_app'].Component);}}],[{key:\"_rewriteUrlForNextExport\",value:function _rewriteUrlForNextExport(url){if(process.env.__NEXT_EXPORT_TRAILING_SLASH){var rewriteUrlForNextExport=require(\"./rewrite-url-for-export\").rewriteUrlForNextExport;return rewriteUrlForNextExport(url);}else{return url;}}}]);return Router;}();exports.default=Router;Router.events=mitt_1.default();","map":null,"metadata":{},"sourceType":"script"}